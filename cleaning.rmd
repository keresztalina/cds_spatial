---
title: "cleaning"
author: "Alina Kereszt"
date: "`r Sys.Date()`"
output: html_document
---

```{r, include=FALSE}
# install packages
#install.packages("tidyverse")
```

```{r, include=FALSE}
# load packages
library(tidyverse)
library(tidyr)
```

The purpose of this script is to preprocess the data involved in this project, part of the Spatial Data Science course in the S23 Cultural Data Science elective at Aarhus University. This project seeks to search an inventory of flats for sale in Budapest, Hungary, based on a number of different criteria.

# Preprocess 'flats.csv'
## Load data
The data is first loaded.
```{r}
flats <- read.csv("data/flats.csv")
```

## Remove unnecessary columns
Some columns are unnecessary for the purpose of this analysis. These are removed.
```{r}
flats <- flats %>% 
  select(!c(X, 
            common_cost,
            date_scraped,
            description,
            furniture,
            image_folder_name,
            image_urls,
            title))
```

## Translation-type transformations
The remaining columns contain information in Hungarian. In order to be more understandable in an English-language course, I am translating this information into English. I am also making any necessary transformations to data format.

Transforming the 'animals' column.
```{r}
# convert to factor
flats$animals <- as.factor(flats$animals)

# convert contents to English
levels(flats$animals) <- c(NA, 
                           "only small pets", 
                           "yes", 
                           "no")
```

Transforming the 'condition' column.
```{r}
# convert to factor
flats$condition <- as.factor(flats$condition)

# convert contents to English
levels(flats$condition) <- c(NA, 
                             "in need of renovation", 
                             "renovated", 
                             "good",
                             "newly built",
                             "like new")
```

Transforming the 'elevator' column.
```{r}
# convert to factor
flats$elevator <- as.factor(flats$elevator)

# convert contents to English
levels(flats$elevator)
levels(flats$elevator) <- c(NA, 
                            "no",
                            "yes")
```

Transforming the 'energy_certificate' column.
```{r}
# convert to factor
flats$energy_certificate <- as.factor(flats$energy_certificate)

# convert contents to English
levels(flats$energy_certificate) <- c(NA,
                                      "a",
                                      "a+",
                                      "b", 
                                      "c",
                                      "d",
                                      "e",
                                      "f",
                                      "g",
                                      "h",
                                      "i" )
```

Transforming the 'garden' column.
```{r}
# convert to factor
flats$garden <- as.factor(flats$garden)

# convert contents to English
levels(flats$garden) <- c(NA,
                          "yes",
                          "no")
```

Transforming the 'heating_type' column.
```{r}
# convert to factor
flats$heating_type <- as.factor(flats$heating_type)

# convert contents to English
levels(flats$heating_type) <- c(NA,
                                "other",
                                "central heating with own meter (entire building)",
                                "electric",
                                "circulated hot water",
                                "gas convection",
                                "central heating (entire building)",
                                "fireplace",
                                "central heating (apartment)",
                                "district heating")
```

Transforming the 'type' column.
```{r}
# convert to factor
flats$type <- as.factor(flats$type)

# convert contents to English
levels(flats$type) <- c(NA,
                        "other",
                        "prefabricated concrete",
                        "brick")
```

Transforming the 'view_type' column.
```{r}
# convert to factor
flats$view_type <- as.factor(flats$view_type)

# convert contents to English
levels(flats$view_type) <- c(NA,
                             "garden",
                             "whole panorama",
                             "partial panorama",
                             "nature",
                             "yard",
                             "street")
```

## Numeric-type transformations
Ensuring appropriate encoding of numeric columns.
```{r}
flats$price <- as.numeric(flats$price)
flats$rooms <- as.numeric(flats$rooms)
flats$size <- as.numeric(flats$size)
```

The prices listed for these apartments show the price per square meter. We also want to know the total price.
```{r}
# rename column for easier understanding
names(flats)[names(flats) == "price"] <- "price_per_sq_meter"

# create column for total price by multiplying the price per square meter
# with the amount of square meters
flats$price_total <- flats$price_per_sq_meter * flats$size
```

The coordinates for each apartment are listed within a single cell. For easier handling, the coordinates are split into latitude and longitude.
```{r}
# separate into 2 columns by comma
flats <- flats %>% 
  separate_wider_delim(location, 
                       delim = ",", 
                       names = c("latitude", 
                                 "longitude"))

# clean of unnecessary characters
flats$latitude <- gsub("\\(",
                       "",
                       flats$latitude)
flats$longitude <- gsub("\\)",
                        "",
                        flats$longitude)

# ensure appropriate encoding
flats$latitude <- as.numeric(flats$latitude)
flats$longitude <- as.numeric(flats$longitude)
```

The administrative divisions of Budapest are numbered. Here, these numbers are extracted.
```{r}
flats$location_str <- gsub("Budapest, ",
                           "",
                           flats$location_str)
flats$location_str <- gsub(". kerÃ¼let,* *.*",
                           "",
                           flats$location_str)
flats$location_str <- gsub(" ",
                           "",
                           flats$location_str)

flats$location_str <- as.roman(flats$location_str)
flats$location_str <- as.numeric(flats$location_str)

names(flats)[names(flats) == "location_str"] <- "quarter"
```

## Save as new file
This is so that the preprocessing code only needs to be run once.
```{r}
write.csv(flats, 
          "data/flats_revised.csv")
```

# Preprocess public transport data
## Load data
The data is first loaded.
```{r}
stops <- read.csv("data/stops.txt")
stop_times <- read.csv("data/stop_times.txt")
trips <- read.csv("data/trips.txt")
routes <- read.csv("data/routes.txt")
```

## Select necessary variables
Not all the variables are needed for our analysis, so only the most necessary are kept for ease of data wrangling.
```{r}
s <- stops %>% 
  select(stop_id,
         stop_name,
         stop_lat,
         stop_lon)
rm(stops)
```

```{r}
r <- routes %>% 
  select(route_id,
         route_short_name,
         route_type)
rm(routes) # remove unnecessary data frame

# convert variable to factor for easier processing
r$route_type <- as.factor(r$route_type)

# define levels
levels(r$route_type) <- c("tram",
                          "metro",
                          "bus",
                          "ship",
                          "trolleybus",
                          "commuter rail")
```

```{r}
t <- trips %>% 
  select(route_id,
         trip_id) 
rm(trips) # remove unnecessary data frame
```

```{r}
st <- stop_times %>% 
  select(trip_id,
         stop_id)
rm(stop_times) # remove unnecessary data frame
```

## Pull data together
The data needed for our analysis is divided among four data frames, which need to be pulled together. Sometimes, certain variables do not find their correspondences, resulting in NAs. These rows are always removed. This results in some loss of data, but the relative quantity of rows containing NAs is always negligible.
```{r}
# join data of stops with data of trips
df <- left_join(s, st)
df <- df %>% 
  filter(!is.na(trip_id))
rm(s) # remove unnecessary data frame
rm(st) # remove unnecessary data frame

# join with data of possible routes
df <- left_join(df, t)
rm(t) # remove unnecessary data frame

# join with data of route info
df <- left_join(df, r)
```

































